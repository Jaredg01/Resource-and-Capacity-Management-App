{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/SAIT/capstone_project/Resource-and-Capacity-Management-App/resource-and-capacity-management-app/app/api/Resource-Manager/Initiatives/route.js"],"sourcesContent":["/* ---------------------------------------------------------\r\n   IMPORTS & DATABASE CLIENT SETUP\r\n   - NextResponse: used to return API responses in Next.js\r\n   - MongoClient: used to connect to MongoDB Atlas\r\n   - uri: connection string stored in environment variables\r\n   - client: reusable MongoDB client instance\r\n--------------------------------------------------------- */\r\nimport { NextResponse } from \"next/server\";\r\nimport { MongoClient } from \"mongodb\";\r\n\r\nconst uri = process.env.MONGODB_URI;\r\nconst client = new MongoClient(uri);\r\n\r\n/* ---------------------------------------------------------\r\n   DATABASE CONNECTION HANDLER\r\n   - Ensures a single MongoDB connection is reused\r\n   - Prevents multiple connections during hot reload\r\n   - Returns the active database instance\r\n   - Database name: ResourceManagementAPP_DB\r\n--------------------------------------------------------- */\r\nasync function connectDB() {\r\n  if (!client.topology || !client.topology.isConnected()) {\r\n    await client.connect();\r\n    console.log(\"Connected to MongoDB (assignment)\");\r\n  }\r\n  return client.db(\"ResourceManagementAPP_DB\");\r\n}\r\n\r\n/* ---------------------------------------------------------\r\n   GET: FETCH ASSIGNMENTS WITH RELATIONAL LOOKUPS\r\n   - Retrieves all assignment records\r\n   - Performs two relational lookups:\r\n       1. requestor_vp → employee.emp_name\r\n       2. employee.dept_no → department.dept_no\r\n   - Returns a fully enriched dataset to the frontend\r\n   - ALSO resolves \"My Initiatives\" when username is provided\r\n\r\n   Pipeline Steps:\r\n   1. Lookup VP employee record\r\n   2. Lookup department for that employee\r\n   3. Project final fields into clean output format\r\n\r\n   Output Fields:\r\n   - project_name\r\n   - category\r\n   - leader\r\n   - status\r\n   - requestor\r\n   - requestor_vp\r\n   - requesting_dept\r\n   - target_period\r\n   - completion_date\r\n   - description\r\n   - resource_notes\r\n--------------------------------------------------------- */\r\nexport async function GET(request) {\r\n  try {\r\n    const db = await connectDB();\r\n\r\n    /* ---------------------------------------------------------\r\n       OPTIONAL: USERNAME FOR \"MY INITIATIVES\"\r\n       - If provided, backend will also return initiatives\r\n         where the logged-in user is the leader.\r\n    --------------------------------------------------------- */\r\n    const { searchParams } = new URL(request.url);\r\n    const username = searchParams.get(\"username\");\r\n\r\n    /* ---------------------------------------------------------\r\n       FETCH ALL ASSIGNMENTS (WITH LOOKUPS)\r\n       - Joins VP → employee → department\r\n       - Produces enriched assignment objects\r\n    --------------------------------------------------------- */\r\n    const allAssignments = await db.collection(\"assignment\").aggregate([\r\n      {\r\n        $lookup: {\r\n          from: \"employee\",\r\n          localField: \"requestor_vp\",\r\n          foreignField: \"emp_name\",\r\n          as: \"vp_employee\"\r\n        }\r\n      },\r\n      { $unwind: { path: \"$vp_employee\", preserveNullAndEmptyArrays: true } },\r\n\r\n      {\r\n        $lookup: {\r\n          from: \"department\",\r\n          localField: \"vp_employee.dept_no\",\r\n          foreignField: \"dept_no\",\r\n          as: \"vp_department\"\r\n        }\r\n      },\r\n      { $unwind: { path: \"$vp_department\", preserveNullAndEmptyArrays: true } },\r\n\r\n      {\r\n        $project: {\r\n          _id: 1,\r\n          project_name: 1,\r\n          category: 1,\r\n          leader: 1,\r\n          status: 1,\r\n          requestor: 1,\r\n          requestor_vp: 1,\r\n          requesting_dept: \"$vp_department.dept_name\",\r\n          target_period: 1,\r\n          completion_date: 1,\r\n          description: 1,\r\n          resource_notes: 1\r\n        }\r\n      }\r\n    ]).toArray();\r\n\r\n    /* ---------------------------------------------------------\r\n       RESOLVE \"MY INITIATIVES\" (IF USERNAME PROVIDED)\r\n       ERD Chain:\r\n       1. account.username → emp_id\r\n       2. employee.emp_id → emp_name\r\n       3. assignment.leader === emp_name\r\n    --------------------------------------------------------- */\r\n    let myInitiatives = [];\r\n\r\n    if (username) {\r\n      const account = await db.collection(\"account\").findOne({\r\n        \"account.username\": username\r\n      });\r\n\r\n      if (account) {\r\n        const employee = await db.collection(\"employee\").findOne({\r\n          emp_id: account.emp_id\r\n        });\r\n\r\n        if (employee) {\r\n          myInitiatives = allAssignments.filter(\r\n            (i) => i.leader === employee.emp_name && i.status !== \"Completed\"\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    /* ---------------------------------------------------------\r\n       SUCCESS RESPONSE\r\n       - Returns both:\r\n         1. allAssignments → full dataset\r\n         2. myInitiatives → filtered by logged-in user\r\n    --------------------------------------------------------- */\r\n    return NextResponse.json({\r\n      allAssignments,\r\n      myInitiatives\r\n    });\r\n\r\n  } catch (err) {\r\n    /* ---------------------------------------------------------\r\n       ERROR HANDLING\r\n       - Logs server-side error\r\n       - Returns 500 response to frontend\r\n    --------------------------------------------------------- */\r\n    console.error(\"Assignment API error:\", err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":"AAAA;;;;;;0DAM0D;;;;AAC1D;AACA;;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AACnC,MAAM,SAAS,IAAI,sHAAW,CAAC;AAE/B;;;;;;0DAM0D,GAC1D,eAAe;IACb,IAAI,CAAC,OAAO,QAAQ,IAAI,CAAC,OAAO,QAAQ,CAAC,WAAW,IAAI;QACtD,MAAM,OAAO,OAAO;QACpB,QAAQ,GAAG,CAAC;IACd;IACA,OAAO,OAAO,EAAE,CAAC;AACnB;AA6BO,eAAe,IAAI,OAAO;IAC/B,IAAI;QACF,MAAM,KAAK,MAAM;QAEjB;;;;8DAI0D,GAC1D,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAElC;;;;8DAI0D,GAC1D,MAAM,iBAAiB,MAAM,GAAG,UAAU,CAAC,cAAc,SAAS,CAAC;YACjE;gBACE,SAAS;oBACP,MAAM;oBACN,YAAY;oBACZ,cAAc;oBACd,IAAI;gBACN;YACF;YACA;gBAAE,SAAS;oBAAE,MAAM;oBAAgB,4BAA4B;gBAAK;YAAE;YAEtE;gBACE,SAAS;oBACP,MAAM;oBACN,YAAY;oBACZ,cAAc;oBACd,IAAI;gBACN;YACF;YACA;gBAAE,SAAS;oBAAE,MAAM;oBAAkB,4BAA4B;gBAAK;YAAE;YAExE;gBACE,UAAU;oBACR,KAAK;oBACL,cAAc;oBACd,UAAU;oBACV,QAAQ;oBACR,QAAQ;oBACR,WAAW;oBACX,cAAc;oBACd,iBAAiB;oBACjB,eAAe;oBACf,iBAAiB;oBACjB,aAAa;oBACb,gBAAgB;gBAClB;YACF;SACD,EAAE,OAAO;QAEV;;;;;;8DAM0D,GAC1D,IAAI,gBAAgB,EAAE;QAEtB,IAAI,UAAU;YACZ,MAAM,UAAU,MAAM,GAAG,UAAU,CAAC,WAAW,OAAO,CAAC;gBACrD,oBAAoB;YACtB;YAEA,IAAI,SAAS;gBACX,MAAM,WAAW,MAAM,GAAG,UAAU,CAAC,YAAY,OAAO,CAAC;oBACvD,QAAQ,QAAQ,MAAM;gBACxB;gBAEA,IAAI,UAAU;oBACZ,gBAAgB,eAAe,MAAM,CACnC,CAAC,IAAM,EAAE,MAAM,KAAK,SAAS,QAAQ,IAAI,EAAE,MAAM,KAAK;gBAE1D;YACF;QACF;QAEA;;;;;8DAK0D,GAC1D,OAAO,oMAAY,CAAC,IAAI,CAAC;YACvB;YACA;QACF;IAEF,EAAE,OAAO,KAAK;QACZ;;;;8DAI0D,GAC1D,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,oMAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}