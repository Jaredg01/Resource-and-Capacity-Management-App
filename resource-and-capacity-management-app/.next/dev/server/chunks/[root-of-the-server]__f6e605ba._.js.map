{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/SAIT/capstone_project/Resource-and-Capacity-Management-App/resource-and-capacity-management-app/app/api/Resource-Manager/calendar-view/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { MongoClient } from 'mongodb';\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI;\r\nconst DB_NAME = 'ResourceManagementAPP_DB';\r\n\r\nlet client = null;\r\n\r\n/* ---------------------------------------------------------\r\n   MONGODB CLIENT (Singleton)\r\n   ---------------------------------------------------------\r\n   PURPOSE:\r\n   - Ensures only one MongoDB client instance is created\r\n   - Prevents repeated connections in serverless environments\r\n   - Reuses the same connection for GET + POST handlers\r\n--------------------------------------------------------- */\r\nasync function getClient() {\r\n  if (!client) {\r\n    client = new MongoClient(MONGODB_URI);\r\n    await client.connect(); // Establish connection once\r\n  }\r\n  return client;\r\n}\r\n\r\n/* ---------------------------------------------------------\r\n   Convert YYYYMM → \"Jan-25\"\r\n   ---------------------------------------------------------\r\n   PURPOSE:\r\n   - Converts numeric YYYYMM format into a readable label\r\n   - Used for dropdowns, tables, and UI month headers\r\n--------------------------------------------------------- */\r\nfunction formatMonthLabel(yyyymm) {\r\n  const s = String(yyyymm);\r\n  const year = Number(s.slice(0, 4));\r\n  const month = Number(s.slice(4, 6));\r\n\r\n  const date = new Date(year, month - 1, 1);\r\n  const shortMonth = date.toLocaleString('en-US', { month: 'short' });\r\n  const shortYear = String(year).slice(2);\r\n\r\n  return `${shortMonth}-${shortYear}`;\r\n}\r\n\r\n/* ---------------------------------------------------------\r\n   GET → AVAILABLE MONTHS (Last 12 Months)\r\n   ---------------------------------------------------------\r\n   PURPOSE:\r\n   - Retrieves distinct YYYYMM values from allocation collection\r\n   - Filters to last 12 months up to current month\r\n   - Returns both raw numeric months + formatted labels\r\n--------------------------------------------------------- */\r\nexport async function GET() {\r\n  try {\r\n    const mongo = await getClient();\r\n    const db = mongo.db(DB_NAME);\r\n    const allocationCol = db.collection('allocation');\r\n\r\n    // Pull distinct month values (e.g., Int32(202507))\r\n    const rawMonths = await allocationCol.distinct('date');\r\n\r\n    if (!rawMonths || rawMonths.length === 0) {\r\n      return NextResponse.json({\r\n        success: true,\r\n        months: [],\r\n        formatted: []\r\n      });\r\n    }\r\n\r\n    // Normalize to plain JS numbers\r\n    const numericMonths = rawMonths\r\n      .map((m) => Number(m))\r\n      .filter((m) => !Number.isNaN(m)); // Remove invalid entries\r\n\r\n    const today = new Date();\r\n    const thisYYYYMM = today.getFullYear() * 100 + (today.getMonth() + 1);\r\n\r\n    // Compute YYYYMM for 12 months ago\r\n    const oneYearAgo = new Date(today);\r\n    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);\r\n    const oneYearAgoYYYYMM =\r\n      oneYearAgo.getFullYear() * 100 + (oneYearAgo.getMonth() + 1);\r\n\r\n    // Keep only months within the last 12 months\r\n    const filtered = numericMonths\r\n      .filter((m) => m >= oneYearAgoYYYYMM && m <= thisYYYYMM)\r\n      .sort((a, b) => a - b);\r\n\r\n    // Attach formatted labels\r\n    const formatted = filtered.map((m) => ({\r\n      yyyymm: m,\r\n      label: formatMonthLabel(m)\r\n    }));\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      months: filtered,\r\n      formatted\r\n    });\r\n  } catch (err) {\r\n    console.error('Error in GET /calendar-view:', err);\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to load available months' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/* ---------------------------------------------------------\r\n   POST → ACTIVITIES GROUPED BY MONTH (WITH CATEGORY)\r\n   ---------------------------------------------------------\r\n   PURPOSE:\r\n   - Accepts array of YYYYMM values\r\n   - Optionally filters by employee ID\r\n   - Returns unique { activity, category } pairs per month\r\n--------------------------------------------------------- */\r\nexport async function POST(req) {\r\n  try {\r\n    const { months, emp_id } = await req.json();\r\n\r\n    // Validate input\r\n    if (!months || !Array.isArray(months) || months.length === 0) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Months array is required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const mongo = await getClient();\r\n    const db = mongo.db(DB_NAME);\r\n    const allocationCol = db.collection('allocation');\r\n\r\n    // Build query\r\n    const query = {\r\n      date: { $in: months },\r\n      ...(emp_id ? { emp_id } : {})\r\n    };\r\n\r\n    // Fetch all matching rows\r\n    const results = await allocationCol.find(query).toArray();\r\n\r\n    /* -----------------------------------------------------\r\n       GROUP ACTIVITIES BY MONTH (WITH CATEGORY)\r\n    ----------------------------------------------------- */\r\n    const activitiesByMonth = months.map((yyyymm) => {\r\n      const monthRows = results.filter(\r\n        (r) => Number(r.date) === Number(yyyymm)\r\n      );\r\n\r\n      const unique = [];\r\n      const seen = new Set();\r\n\r\n      monthRows.forEach((r) => {\r\n        const key = `${r.activity}__${r.category}`;\r\n        if (!seen.has(key)) {\r\n          seen.add(key);\r\n          unique.push({\r\n            activity: r.activity,\r\n            category: r.category\r\n          });\r\n        }\r\n      });\r\n\r\n      return {\r\n        yyyymm,\r\n        label: formatMonthLabel(yyyymm),\r\n        activities: unique\r\n      };\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      activitiesByMonth\r\n    });\r\n\r\n  } catch (err) {\r\n    console.error('Error in POST /calendar-view:', err);\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to load activities' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}