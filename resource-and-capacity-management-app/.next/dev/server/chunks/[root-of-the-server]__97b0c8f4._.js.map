{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/SAIT/capstone_project/Resource-and-Capacity-Management-App/resource-and-capacity-management-app/app/api/profile/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { MongoClient } from 'mongodb';\r\n\r\n// ---------------------------------------------------------\r\n// MongoDB Connection Setup (Native Driver)\r\n// ---------------------------------------------------------\r\n\r\n// Connection string from environment variables\r\nconst uri = process.env.MONGODB_URI;\r\n\r\n// Create a single MongoClient instance for reuse\r\nconst client = new MongoClient(uri);\r\n\r\n/**\r\n * Ensures a single, reusable MongoDB connection.\r\n * - Prevents multiple connections during Next.js hot reloads\r\n * - Returns the active database instance\r\n */\r\nasync function connectDB() {\r\n  if (!client.topology || !client.topology.isConnected()) {\r\n    await client.connect();\r\n    console.log(\"‚úÖ Connected to MongoDB (Native Driver)\");\r\n  }\r\n  return client.db();\r\n}\r\n\r\n// ---------------------------------------------------------\r\n// GET /api/profile\r\n// Fetches full profile details for a given username\r\n// ---------------------------------------------------------\r\n\r\nexport async function GET(req) {\r\n  try {\r\n    // Extract username from query string\r\n    const username = req.nextUrl.searchParams.get('username');\r\n\r\n    // Validate required input\r\n    if (!username) {\r\n      return NextResponse.json({ error: \"Missing username\" }, { status: 400 });\r\n    }\r\n\r\n    // Connect to database\r\n    const db = await connectDB();\r\n\r\n    // -----------------------------------------------------\r\n    // 1. Look up account using nested field: account.username\r\n    // -----------------------------------------------------\r\n    const accountDoc = await db.collection('account').findOne({\r\n      'account.username': username.trim()\r\n    });\r\n\r\n    if (!accountDoc) {\r\n      return NextResponse.json({ error: \"Account not found\" }, { status: 404 });\r\n    }\r\n\r\n    // Extract foreign keys from account document\r\n    const empId = accountDoc.emp_id;\r\n    const accTypeId = accountDoc.account?.acc_type_id;\r\n\r\n    console.log(\"üîç emp_id:\", empId);\r\n    console.log(\"üîç acc_type_id:\", accTypeId);\r\n\r\n    // -----------------------------------------------------\r\n    // 2. Fetch employee details using emp_id\r\n    // -----------------------------------------------------\r\n    const employee = await db.collection('employee').findOne({ emp_id: empId });\r\n\r\n    // -----------------------------------------------------\r\n    // 3. Fetch department details using dept_no from employee\r\n    // -----------------------------------------------------\r\n    const department = employee\r\n      ? await db.collection('department').findOne({ dept_no: employee.dept_no })\r\n      : null;\r\n\r\n    // -----------------------------------------------------\r\n    // 4. Fetch account type (role) using acc_type_id\r\n    // -----------------------------------------------------\r\n    const accountType = await db.collection('account_type').findOne({\r\n      acc_type_id: accTypeId\r\n    });\r\n\r\n    if (!accountType) {\r\n      console.log(\"‚ö†Ô∏è Account type not found for acc_type_id:\", accTypeId);\r\n    }\r\n\r\n    // -----------------------------------------------------\r\n    // 5. Build final profile response object\r\n    // -----------------------------------------------------\r\n    const profile = {\r\n      name: employee?.emp_name || \"\",\r\n      title: employee?.emp_title || \"\",\r\n      department: department?.dept_name || \"\",\r\n      role: accountType?.acc_type || \"\",\r\n      id: employee?.emp_id || \"\"\r\n    };\r\n\r\n    // Return profile to frontend\r\n    return NextResponse.json(profile);\r\n\r\n  } catch (err) {\r\n    // Catch unexpected server errors\r\n    console.error(\"üî• Profile API error:\", err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,4DAA4D;AAC5D,2CAA2C;AAC3C,4DAA4D;AAE5D,+CAA+C;AAC/C,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AAEnC,iDAAiD;AACjD,MAAM,SAAS,IAAI,wNAAW,CAAC;AAE/B;;;;CAIC,GACD,eAAe;IACb,IAAI,CAAC,OAAO,QAAQ,IAAI,CAAC,OAAO,QAAQ,CAAC,WAAW,IAAI;QACtD,MAAM,OAAO,OAAO;QACpB,QAAQ,GAAG,CAAC;IACd;IACA,OAAO,OAAO,EAAE;AAClB;AAOO,eAAe,IAAI,GAAG;IAC3B,IAAI;QACF,qCAAqC;QACrC,MAAM,WAAW,IAAI,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;QAE9C,0BAA0B;QAC1B,IAAI,CAAC,UAAU;YACb,OAAO,oMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,sBAAsB;QACtB,MAAM,KAAK,MAAM;QAEjB,wDAAwD;QACxD,0DAA0D;QAC1D,wDAAwD;QACxD,MAAM,aAAa,MAAM,GAAG,UAAU,CAAC,WAAW,OAAO,CAAC;YACxD,oBAAoB,SAAS,IAAI;QACnC;QAEA,IAAI,CAAC,YAAY;YACf,OAAO,oMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,6CAA6C;QAC7C,MAAM,QAAQ,WAAW,MAAM;QAC/B,MAAM,YAAY,WAAW,OAAO,EAAE;QAEtC,QAAQ,GAAG,CAAC,cAAc;QAC1B,QAAQ,GAAG,CAAC,mBAAmB;QAE/B,wDAAwD;QACxD,yCAAyC;QACzC,wDAAwD;QACxD,MAAM,WAAW,MAAM,GAAG,UAAU,CAAC,YAAY,OAAO,CAAC;YAAE,QAAQ;QAAM;QAEzE,wDAAwD;QACxD,0DAA0D;QAC1D,wDAAwD;QACxD,MAAM,aAAa,WACf,MAAM,GAAG,UAAU,CAAC,cAAc,OAAO,CAAC;YAAE,SAAS,SAAS,OAAO;QAAC,KACtE;QAEJ,wDAAwD;QACxD,iDAAiD;QACjD,wDAAwD;QACxD,MAAM,cAAc,MAAM,GAAG,UAAU,CAAC,gBAAgB,OAAO,CAAC;YAC9D,aAAa;QACf;QAEA,IAAI,CAAC,aAAa;YAChB,QAAQ,GAAG,CAAC,8CAA8C;QAC5D;QAEA,wDAAwD;QACxD,yCAAyC;QACzC,wDAAwD;QACxD,MAAM,UAAU;YACd,MAAM,UAAU,YAAY;YAC5B,OAAO,UAAU,aAAa;YAC9B,YAAY,YAAY,aAAa;YACrC,MAAM,aAAa,YAAY;YAC/B,IAAI,UAAU,UAAU;QAC1B;QAEA,6BAA6B;QAC7B,OAAO,oMAAY,CAAC,IAAI,CAAC;IAE3B,EAAE,OAAO,KAAK;QACZ,iCAAiC;QACjC,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,oMAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}