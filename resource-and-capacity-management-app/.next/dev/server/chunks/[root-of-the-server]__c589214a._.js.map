{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/SAIT/capstone_project/Resource-and-Capacity-Management-App/resource-and-capacity-management-app/app/api/Resource-Manager/Initiatives/Dropdowns/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { MongoClient } from \"mongodb\";\r\n\r\n/* ---------------------------------------------------------\r\n   MONGODB CONNECTION SETUP\r\n   - Loads connection string from environment\r\n   - Reuses a single MongoClient instance\r\n   - Prevents duplicate connections during hot reloads\r\n--------------------------------------------------------- */\r\n\r\n// Connection string loaded from environment variables\r\nconst uri = process.env.MONGODB_URI;\r\n\r\n// Shared MongoDB client instance\r\nconst client = new MongoClient(uri);\r\n\r\n/* ---------------------------------------------------------\r\n   CONNECT TO DATABASE\r\n   - Opens a connection only if not already active\r\n   - Ensures stable DB access across API calls\r\n   - Returns active database instance (explicit DB name)\r\n--------------------------------------------------------- */\r\nasync function connectDB() {\r\n  if (!client.topology || !client.topology.isConnected()) {\r\n    await client.connect();\r\n  }\r\n  return client.db(\"ResourceManagementAPP_DB\");\r\n}\r\n\r\n/* ---------------------------------------------------------\r\n   GET /api/Resource-Manager/Initiatives/dropdowns\r\n   - Loads dropdown values for:\r\n       • Leads (acc_type_id = 1)\r\n       • Requestors + Requestor VPs (acc_type_id = 1 or 2)\r\n   - Used by Add/Edit Initiative forms\r\n--------------------------------------------------------- */\r\nexport async function GET() {\r\n  try {\r\n    const db = await connectDB();\r\n\r\n    /* ---------------------------------------------------------\r\n       LEADS (acc_type_id = 1)\r\n       - Fetches all Resource Managers\r\n       - Joins employee info via emp_id\r\n       - Returns only employee names\r\n    --------------------------------------------------------- */\r\n    const leads = await db.collection(\"account\").aggregate([\r\n      {\r\n        $match: {\r\n          \"account.acc_type_id\": 1, // Resource Managers only\r\n        },\r\n      },\r\n      {\r\n        $lookup: {\r\n          from: \"employee\",\r\n          localField: \"emp_id\",\r\n          foreignField: \"emp_id\",\r\n          as: \"employee_info\",\r\n        },\r\n      },\r\n      { $unwind: \"$employee_info\" },\r\n      {\r\n        $project: {\r\n          _id: 0,\r\n          emp_name: \"$employee_info.emp_name\",\r\n        },\r\n      },\r\n    ]).toArray();\r\n\r\n    /* ---------------------------------------------------------\r\n       REQUESTORS + REQUESTOR VPs (acc_type_id = 1 or 2)\r\n       - Fetches all employees eligible for:\r\n           • Requestor dropdown\r\n           • Requestor VP dropdown\r\n       - Includes:\r\n           • Resource Managers (1)\r\n           • Requestors / VPs (2)\r\n       - Returns:\r\n           • emp_name\r\n           • acc_type_id (useful for UI grouping)\r\n    --------------------------------------------------------- */\r\n    const requestors = await db.collection(\"account\").aggregate([\r\n      {\r\n        $match: {\r\n          \"account.acc_type_id\": { $in: [1, 2] },\r\n        },\r\n      },\r\n      {\r\n        $lookup: {\r\n          from: \"employee\",\r\n          localField: \"emp_id\",\r\n          foreignField: \"emp_id\",\r\n          as: \"employee_info\",\r\n        },\r\n      },\r\n      { $unwind: \"$employee_info\" },\r\n      {\r\n        $project: {\r\n          _id: 0,\r\n          emp_name: \"$employee_info.emp_name\",\r\n          acc_type_id: \"$account.acc_type_id\",\r\n        },\r\n      },\r\n    ]).toArray();\r\n\r\n    /* ---------------------------------------------------------\r\n       RESPONSE PAYLOAD\r\n       - Returns structured dropdown lists\r\n       - Used by frontend initiative forms\r\n    --------------------------------------------------------- */\r\n    return NextResponse.json({\r\n      employees: leads,\r\n      requestors: requestors,\r\n    });\r\n\r\n  } catch (err) {\r\n    /* ---------------------------------------------------------\r\n       ERROR HANDLING\r\n       - Logs unexpected server errors\r\n       - Returns generic failure response\r\n    --------------------------------------------------------- */\r\n    console.error(\"Dropdown API error:\", err);\r\n\r\n    return NextResponse.json(\r\n      { error: \"Failed to load employee names\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA;;;;;0DAK0D,GAE1D,sDAAsD;AACtD,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AAEnC,iCAAiC;AACjC,MAAM,SAAS,IAAI,wNAAW,CAAC;AAE/B;;;;;0DAK0D,GAC1D,eAAe;IACb,IAAI,CAAC,OAAO,QAAQ,IAAI,CAAC,OAAO,QAAQ,CAAC,WAAW,IAAI;QACtD,MAAM,OAAO,OAAO;IACtB;IACA,OAAO,OAAO,EAAE,CAAC;AACnB;AASO,eAAe;IACpB,IAAI;QACF,MAAM,KAAK,MAAM;QAEjB;;;;;8DAK0D,GAC1D,MAAM,QAAQ,MAAM,GAAG,UAAU,CAAC,WAAW,SAAS,CAAC;YACrD;gBACE,QAAQ;oBACN,uBAAuB;gBACzB;YACF;YACA;gBACE,SAAS;oBACP,MAAM;oBACN,YAAY;oBACZ,cAAc;oBACd,IAAI;gBACN;YACF;YACA;gBAAE,SAAS;YAAiB;YAC5B;gBACE,UAAU;oBACR,KAAK;oBACL,UAAU;gBACZ;YACF;SACD,EAAE,OAAO;QAEV;;;;;;;;;;;8DAW0D,GAC1D,MAAM,aAAa,MAAM,GAAG,UAAU,CAAC,WAAW,SAAS,CAAC;YAC1D;gBACE,QAAQ;oBACN,uBAAuB;wBAAE,KAAK;4BAAC;4BAAG;yBAAE;oBAAC;gBACvC;YACF;YACA;gBACE,SAAS;oBACP,MAAM;oBACN,YAAY;oBACZ,cAAc;oBACd,IAAI;gBACN;YACF;YACA;gBAAE,SAAS;YAAiB;YAC5B;gBACE,UAAU;oBACR,KAAK;oBACL,UAAU;oBACV,aAAa;gBACf;YACF;SACD,EAAE,OAAO;QAEV;;;;8DAI0D,GAC1D,OAAO,oMAAY,CAAC,IAAI,CAAC;YACvB,WAAW;YACX,YAAY;QACd;IAEF,EAAE,OAAO,KAAK;QACZ;;;;8DAI0D,GAC1D,QAAQ,KAAK,CAAC,uBAAuB;QAErC,OAAO,oMAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAgC,GACzC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}