{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/SAIT/capstone_project/Resource-and-Capacity-Management-App/resource-and-capacity-management-app/app/api/Resource-Manager/profile/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { MongoClient } from 'mongodb';\r\n\r\n/* ---------------------------------------------------------\r\n   MONGODB CONNECTION SETUP\r\n   - Loads connection string from environment\r\n   - Reuses a single MongoClient instance\r\n   - Prevents duplicate connections during hot reloads\r\n--------------------------------------------------------- */\r\n\r\n// Connection string from environment variables\r\nconst uri = process.env.MONGODB_URI;\r\n\r\n// Shared MongoDB client instance\r\nconst client = new MongoClient(uri);\r\n\r\n/* ---------------------------------------------------------\r\n   CONNECT TO DATABASE\r\n   - Opens a connection only if not already active\r\n   - Ensures stable DB access across API calls\r\n   - Returns active database instance\r\n--------------------------------------------------------- */\r\nasync function connectDB() {\r\n  if (!client.topology || !client.topology.isConnected()) {\r\n    await client.connect();\r\n    console.log(\"Connected to MongoDB (Native Driver)\");\r\n  }\r\n  return client.db(); // Uses default DB from connection string\r\n}\r\n\r\n/* ---------------------------------------------------------\r\n   GET /api/Resource-Manager/profile\r\n   - Retrieves full profile information for a given username\r\n   - Combines account, employee, department, and role data\r\n--------------------------------------------------------- */\r\nexport async function GET(req) {\r\n  try {\r\n    // Extract username from query parameters\r\n    const username = req.nextUrl.searchParams.get('username');\r\n\r\n    /* ---------------------------------------------------------\r\n       INPUT VALIDATION\r\n       - Username must be provided\r\n    --------------------------------------------------------- */\r\n    if (!username) {\r\n      return NextResponse.json({ error: \"Missing username\" }, { status: 400 });\r\n    }\r\n\r\n    // Connect to database\r\n    const db = await connectDB();\r\n\r\n    /* ---------------------------------------------------------\r\n       1. FETCH ACCOUNT RECORD\r\n       - Matches nested field: account.username\r\n       - Ensures exact match (no case-insensitive search)\r\n    --------------------------------------------------------- */\r\n    const accountDoc = await db.collection('account').findOne({\r\n      'account.username': username.trim()\r\n    });\r\n\r\n    if (!accountDoc) {\r\n      return NextResponse.json({ error: \"Account not found\" }, { status: 404 });\r\n    }\r\n\r\n    // Extract foreign keys for additional lookups\r\n    const empId = accountDoc.emp_id;\r\n    const accTypeId = accountDoc.account?.acc_type_id;\r\n\r\n    console.log(\"emp_id:\", empId);\r\n    console.log(\"acc_type_id:\", accTypeId);\r\n\r\n    /* ---------------------------------------------------------\r\n       2. FETCH EMPLOYEE DETAILS\r\n       - Uses emp_id from account record\r\n    --------------------------------------------------------- */\r\n    const employee = await db.collection('employee').findOne({ emp_id: empId });\r\n\r\n    /* ---------------------------------------------------------\r\n       3. FETCH DEPARTMENT DETAILS\r\n       - Uses dept_no from employee record\r\n    --------------------------------------------------------- */\r\n    const department = employee\r\n      ? await db.collection('department').findOne({ dept_no: employee.dept_no })\r\n      : null;\r\n\r\n    /* ---------------------------------------------------------\r\n       4. FETCH ACCOUNT TYPE (ROLE)\r\n       - Uses acc_type_id from account record\r\n    --------------------------------------------------------- */\r\n    const accountType = await db.collection('account_type').findOne({\r\n      acc_type_id: accTypeId\r\n    });\r\n\r\n    if (!accountType) {\r\n      console.log(\"Account type not found for acc_type_id:\", accTypeId);\r\n    }\r\n\r\n    /* ---------------------------------------------------------\r\n       5. BUILD FINAL PROFILE RESPONSE\r\n       - Combines all related data into a single object\r\n    --------------------------------------------------------- */\r\n    const profile = {\r\n      name: employee?.emp_name || \"\",\r\n      title: employee?.emp_title || \"\",\r\n      department: department?.dept_name || \"\",\r\n      role: accountType?.acc_type || \"\",\r\n      id: employee?.emp_id || \"\"\r\n    };\r\n\r\n    // Return profile to frontend\r\n    return NextResponse.json(profile);\r\n\r\n  } catch (err) {\r\n    /* ---------------------------------------------------------\r\n       ERROR HANDLING\r\n       - Catches unexpected server errors\r\n       - Returns generic error response\r\n    --------------------------------------------------------- */\r\n    console.error(\"Profile API error:\", err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA;;;;;0DAK0D,GAE1D,+CAA+C;AAC/C,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AAEnC,iCAAiC;AACjC,MAAM,SAAS,IAAI,wNAAW,CAAC;AAE/B;;;;;0DAK0D,GAC1D,eAAe;IACb,IAAI,CAAC,OAAO,QAAQ,IAAI,CAAC,OAAO,QAAQ,CAAC,WAAW,IAAI;QACtD,MAAM,OAAO,OAAO;QACpB,QAAQ,GAAG,CAAC;IACd;IACA,OAAO,OAAO,EAAE,IAAI,yCAAyC;AAC/D;AAOO,eAAe,IAAI,GAAG;IAC3B,IAAI;QACF,yCAAyC;QACzC,MAAM,WAAW,IAAI,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;QAE9C;;;8DAG0D,GAC1D,IAAI,CAAC,UAAU;YACb,OAAO,oMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,sBAAsB;QACtB,MAAM,KAAK,MAAM;QAEjB;;;;8DAI0D,GAC1D,MAAM,aAAa,MAAM,GAAG,UAAU,CAAC,WAAW,OAAO,CAAC;YACxD,oBAAoB,SAAS,IAAI;QACnC;QAEA,IAAI,CAAC,YAAY;YACf,OAAO,oMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,8CAA8C;QAC9C,MAAM,QAAQ,WAAW,MAAM;QAC/B,MAAM,YAAY,WAAW,OAAO,EAAE;QAEtC,QAAQ,GAAG,CAAC,WAAW;QACvB,QAAQ,GAAG,CAAC,gBAAgB;QAE5B;;;8DAG0D,GAC1D,MAAM,WAAW,MAAM,GAAG,UAAU,CAAC,YAAY,OAAO,CAAC;YAAE,QAAQ;QAAM;QAEzE;;;8DAG0D,GAC1D,MAAM,aAAa,WACf,MAAM,GAAG,UAAU,CAAC,cAAc,OAAO,CAAC;YAAE,SAAS,SAAS,OAAO;QAAC,KACtE;QAEJ;;;8DAG0D,GAC1D,MAAM,cAAc,MAAM,GAAG,UAAU,CAAC,gBAAgB,OAAO,CAAC;YAC9D,aAAa;QACf;QAEA,IAAI,CAAC,aAAa;YAChB,QAAQ,GAAG,CAAC,2CAA2C;QACzD;QAEA;;;8DAG0D,GAC1D,MAAM,UAAU;YACd,MAAM,UAAU,YAAY;YAC5B,OAAO,UAAU,aAAa;YAC9B,YAAY,YAAY,aAAa;YACrC,MAAM,aAAa,YAAY;YAC/B,IAAI,UAAU,UAAU;QAC1B;QAEA,6BAA6B;QAC7B,OAAO,oMAAY,CAAC,IAAI,CAAC;IAE3B,EAAE,OAAO,KAAK;QACZ;;;;8DAI0D,GAC1D,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,oMAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}